name: CodSpeed
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTUP_TOOLCHAIN: stable
  # Performance comparison settings
  TRANSFER_SIZE: 33554432 # 32 MiB

permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  benchmarks:
    name: Benchmarks
    runs-on: # zizmor: ignore[self-hosted-runner]
      labels: codspeed-macro
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          tools: cargo-codspeed
          token: ${{ secrets.GITHUB_TOKEN }}
          cache-key-suffix: -codspeed

      # --- Setup ---
      - name: Set up build artifacts
        run: |
          chmod +x artifacts/build-msquic/*
          chmod +x artifacts/build-google/*
          chmod +x artifacts/build-quiche/*
          chmod +x artifacts/build-s2n/*
          chmod +x artifacts/build-neqo/neqo-client artifacts/build-neqo/neqo-server
          # neqo-crypto/build.rs expects $NSS_DIR/../dist/{Release,public,private}.
          # Our artifacts have those directly under build-neqo/, so create
          # build-neqo/dist -> . and point NSS_DIR at the fake build-neqo/nss subdir.
          ln -sfn . "$GITHUB_WORKSPACE/artifacts/build-neqo/dist"
          {
            echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/artifacts/build-neqo/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$GITHUB_WORKSPACE/artifacts/build-neqo/test-fixture/db"
            echo "NSS_DIR=$GITHUB_WORKSPACE/artifacts/build-neqo/nss"
            echo "NSS_PREBUILT=1"
          } >> "$GITHUB_ENV"

      - name: Setup test environment
        uses: ./.github/actions/testdata-setup
        with:
          sizes: ${{ env.TRANSFER_SIZE }}
          mtu: "1500"

      - name: Prepare machine
        id: cpu-tuning
        uses: ./.github/actions/cpu-tuning
        with:
          select-cpus: "true"

      - name: Set CPU pinning environment
        env:
          SERVER_CPU: ${{ steps.cpu-tuning.outputs.server-cpu }}
          CLIENT_CPU: ${{ steps.cpu-tuning.outputs.client-cpu }}
        run: |
          {
            echo "SERVER_CPU=$SERVER_CPU"
            echo "CLIENT_CPU=$CLIENT_CPU"
          } >> "$GITHUB_ENV"

      # --- quiche vs neqo ---
      - name: Generate commands (quiche-neqo)
        id: cmd-quiche-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/artifacts/build-neqo
          quiche-path: ${{ github.workspace }}/artifacts/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set command environment (quiche-neqo)
        env:
          BENCH_NAME: ${{ steps.cmd-quiche-neqo.outputs.bench-name }}
          SERVER_CMD: ${{ steps.cmd-quiche-neqo.outputs.server-cmd }}
          CLIENT_CMD: ${{ steps.cmd-quiche-neqo.outputs.client-cmd }}
        run: |
          {
            echo "BENCH_NAME=$BENCH_NAME"
            echo "SERVER_CMD=$SERVER_CMD"
            echo "CLIENT_CMD=$CLIENT_CMD"
          } >> "$GITHUB_ENV"

      - name: Start server (quiche-neqo)
        run: |
          # shellcheck disable=SC2086
          sudo LD_LIBRARY_PATH="$LD_LIBRARY_PATH" nice -n -20 taskset -c "$SERVER_CPU" $SERVER_CMD &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"
          sleep 3
          if ! kill -0 "$SERVER_PID" 2>/dev/null; then
            echo "::error::Server (quiche-neqo) exited prematurely"
            exit 1
          fi
          if ! ss -ulnp | grep -q ":4433 "; then
            echo "::error::Server (quiche-neqo) is not listening on UDP port 4433"
            kill "$SERVER_PID" 2>/dev/null || true
            exit 1
          fi

      - name: Create benchmark config (quiche-neqo)
        run: |
          {
            echo "benchmarks:"
            echo "  - name: \"$BENCH_NAME\""
            echo "    exec: sudo --non-interactive -E nice -n -20 taskset -c $CLIENT_CPU $CLIENT_CMD"
            echo "    options:"
            echo "      warmup-time: 10s"
            echo "      min-rounds: 150"
          } > codspeed.yml

      - name: Run benchmark (quiche-neqo)
        uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
        env:
          CODSPEED_PERF_ENABLED: false
        with:
          mode: walltime
          working-directory: /tmp
          upload-url: ${{ secrets.CODSPEED_STAGING_UPLOAD_URL }}
          config: ${{ github.workspace }}/codspeed.yml

      - name: Stop server (quiche-neqo)
        if: always()
        run: kill "$SERVER_PID" 2>/dev/null || true; wait "$SERVER_PID" 2>/dev/null || true

      # --- Criterion (walltime) benchmarks ---
      - name: Build walltime benchmarks
        run: |
          cargo binstall cargo-codspeed --locked --force
          cargo codspeed build -p neqo-bench --features bench --locked -m walltime

      - name: Generate commands (quiche-quiche) for walltime
        id: wt-cmd-quiche-quiche
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: quiche
          size: ${{ env.TRANSFER_SIZE }}
          quiche-path: ${{ github.workspace }}/artifacts/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Generate commands (google-neqo) for walltime
        id: wt-cmd-google-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: google
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/artifacts/build-neqo
          google-path: ${{ github.workspace }}/artifacts/build-google
          testdata-path: ${{ github.workspace }}/testdata

      - name: Generate commands (quiche-neqo) for walltime
        id: wt-cmd-quiche-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/artifacts/build-neqo
          quiche-path: ${{ github.workspace }}/artifacts/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set perfcompare environment
        env:
          SERVER_CPU: ${{ steps.cpu-tuning.outputs.server-cpu }}
          CLIENT_CPU: ${{ steps.cpu-tuning.outputs.client-cpu }}
        run: |
          {
            # echo "QUICHE_QUICHE_SERVER_CMD=nice -n -20 taskset -c $SERVER_CPU ${{ steps.wt-cmd-quiche-quiche.outputs.server-cmd }}"
            # echo "QUICHE_QUICHE_CLIENT_CMD=nice -n -20 taskset -c $CLIENT_CPU ${{ steps.wt-cmd-quiche-quiche.outputs.client-cmd }}"
            # echo "GOOGLE_NEQO_SERVER_CMD=nice -n -20 taskset -c $SERVER_CPU ${{ steps.wt-cmd-google-neqo.outputs.server-cmd }}"
            # echo "GOOGLE_NEQO_CLIENT_CMD=nice -n -20 taskset -c $CLIENT_CPU ${{ steps.wt-cmd-google-neqo.outputs.client-cmd }}"
            echo "QUICHE_NEQO_SERVER_CMD=sudo LD_LIBRARY_PATH=$LD_LIBRARY_PATH nice -n -20 taskset -c $SERVER_CPU ${{ steps.wt-cmd-quiche-neqo.outputs.server-cmd }}"
            echo "QUICHE_NEQO_CLIENT_CMD=sudo LD_LIBRARY_PATH=$LD_LIBRARY_PATH nice -n -20 taskset -c $CLIENT_CPU ${{ steps.wt-cmd-quiche-neqo.outputs.client-cmd }}"
          } >> "$GITHUB_ENV"

      - name: Run Criterion bench & upload results
        uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
        env:
          CODSPEED_PERF_ENABLED: false
        with:
          mode: walltime
          run: |
            cargo binstall cargo-codspeed --locked --force
            cargo codspeed run -p neqo-bench
          upload-url: ${{ secrets.CODSPEED_STAGING_UPLOAD_URL }}

      # --- quiche vs quiche ---
      # - name: Generate commands (quiche-quiche)
      #   id: cmd-quiche-quiche
      #   uses: ./.github/actions/perfcompare-commands
      #   with:
      #     client: quiche
      #     server: quiche
      #     size: ${{ env.TRANSFER_SIZE }}
      #     quiche-path: ${{ github.workspace }}/artifacts/build-quiche
      #     testdata-path: ${{ github.workspace }}/testdata
      #
      # - name: Set command environment (quiche-quiche)
      #   env:
      #     BENCH_NAME: ${{ steps.cmd-quiche-quiche.outputs.bench-name }}
      #     SERVER_CMD: ${{ steps.cmd-quiche-quiche.outputs.server-cmd }}
      #     CLIENT_CMD: ${{ steps.cmd-quiche-quiche.outputs.client-cmd }}
      #   run: |
      #     {
      #       echo "BENCH_NAME=$BENCH_NAME"
      #       echo "SERVER_CMD=$SERVER_CMD"
      #       echo "CLIENT_CMD=$CLIENT_CMD"
      #     } >> "$GITHUB_ENV"
      #
      # - name: Start server (quiche-quiche)
      #   run: |
      #     # shellcheck disable=SC2086
      #     nice -n -20 taskset -c "$SERVER_CPU" $SERVER_CMD &
      #     SERVER_PID=$!
      #     echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"
      #     sleep 3
      #     if ! kill -0 "$SERVER_PID" 2>/dev/null; then
      #       echo "::error::Server (quiche-quiche) exited prematurely"
      #       exit 1
      #     fi
      #     if ! ss -ulnp | grep -q ":4433 "; then
      #       echo "::error::Server (quiche-quiche) is not listening on UDP port 4433"
      #       kill "$SERVER_PID" 2>/dev/null || true
      #       exit 1
      #     fi
      #
      # - run: cargo install --locked --git https://github.com/CodSpeedHQ/codspeed --branch "cod-2233-investigate-neqo-variance" exec-harness --force
      #
      # - name: Create benchmark config (quiche-quiche)
      #   run: |
      #     {
      #       echo "benchmarks:"
      #       echo "  - name: \"$BENCH_NAME\""
      #       echo "    exec: nice -n -20 taskset -c $CLIENT_CPU $CLIENT_CMD"
      #       echo "    options:"
      #       echo "      warmup-time: 10s"
      #       echo "      min-rounds: 150"
      #     } > codspeed.yml
      #
      # - name: Run benchmark (quiche-quiche)
      #   uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
      #   env:
      #     CODSPEED_PERF_ENABLED: false
      #   with:
      #     mode: walltime
      #     working-directory: /tmp
      #     upload-url: ${{ secrets.CODSPEED_STAGING_UPLOAD_URL }}
      #     config: ${{ github.workspace }}/codspeed.yml
      #
      # - name: Stop server (quiche-quiche)
      #   if: always()
      #   run: kill "$SERVER_PID" 2>/dev/null || true; wait "$SERVER_PID" 2>/dev/null || true
      #
      # # --- google vs neqo ---
      # - name: Generate commands (google-neqo)
      #   id: cmd-google-neqo
      #   uses: ./.github/actions/perfcompare-commands
      #   with:
      #     client: google
      #     server: neqo
      #     size: ${{ env.TRANSFER_SIZE }}
      #     cubic: "true"
      #     pacing: "true"
      #     neqo-path: ${{ github.workspace }}/artifacts/build-neqo
      #     google-path: ${{ github.workspace }}/artifacts/build-google
      #     testdata-path: ${{ github.workspace }}/testdata
      #
      # - name: Set command environment (google-neqo)
      #   env:
      #     BENCH_NAME: ${{ steps.cmd-google-neqo.outputs.bench-name }}
      #     SERVER_CMD: ${{ steps.cmd-google-neqo.outputs.server-cmd }}
      #     CLIENT_CMD: ${{ steps.cmd-google-neqo.outputs.client-cmd }}
      #   run: |
      #     {
      #       echo "BENCH_NAME=$BENCH_NAME"
      #       echo "SERVER_CMD=$SERVER_CMD"
      #       echo "CLIENT_CMD=$CLIENT_CMD"
      #     } >> "$GITHUB_ENV"
      #
      # - name: Start server (google-neqo)
      #   run: |
      #     # shellcheck disable=SC2086
      #     nice -n -20 taskset -c "$SERVER_CPU" $SERVER_CMD &
      #     SERVER_PID=$!
      #     echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"
      #     sleep 3
      #     if ! kill -0 "$SERVER_PID" 2>/dev/null; then
      #       echo "::error::Server (google-neqo) exited prematurely"
      #       exit 1
      #     fi
      #     if ! ss -ulnp | grep -q ":4433 "; then
      #       echo "::error::Server (google-neqo) is not listening on UDP port 4433"
      #       kill "$SERVER_PID" 2>/dev/null || true
      #       exit 1
      #     fi
      #
      # - name: Create benchmark config (google-neqo)
      #   run: |
      #     {
      #       echo "benchmarks:"
      #       echo "  - name: \"$BENCH_NAME\""
      #       echo "    exec: nice -n -20 taskset -c $CLIENT_CPU $CLIENT_CMD"
      #       echo "    options:"
      #       echo "      warmup-time: 10s"
      #       echo "      min-rounds: 100"
      #     } > codspeed.yml
      #
      # - name: Run benchmark (google-neqo)
      #   uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
      #   env:
      #     CODSPEED_PERF_ENABLED: false
      #   with:
      #     mode: walltime
      #     working-directory: /tmp
      #     upload-url: ${{ secrets.CODSPEED_STAGING_UPLOAD_URL }}
      #     config: ${{ github.workspace }}/codspeed.yml
      #
      # - name: Stop server (google-neqo)
      #   if: always()
      #   run: kill "$SERVER_PID" 2>/dev/null || true; wait "$SERVER_PID" 2>/dev/null || true
