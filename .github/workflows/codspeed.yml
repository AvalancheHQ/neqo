name: CodSpeed
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTUP_TOOLCHAIN: stable
  # Performance comparison settings
  TRANSFER_SIZE: 33554432 # 32 MiB

permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  bench-matrix:
    name: Determine bench matrix
    runs-on: ubuntu-24.04
    outputs:
      benches: ${{ steps.matrix.outputs.benches }}
      walltime-benches: ${{ steps.matrix.outputs.walltime-benches }}
      has-walltime: ${{ steps.matrix.outputs.has-walltime }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - id: matrix
        uses: ./.github/actions/bench-matrix

  # Build neqo for walltime benchmarks and perfcompare on ARM64.
  # CodSpeed's macro runners are aarch64, so we build on ARM for compatibility.
  # Using ubuntu-22.04 for glibc compatibility with CodSpeed runners.
  build-neqo:
    name: Build neqo
    runs-on: ubuntu-22.04-arm
    needs: bench-matrix
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          tools: cargo-codspeed
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./.github/actions/nss

      - name: Build neqo binaries
        run: |
          export RUSTFLAGS="-C force-frame-pointers=yes"
          cargo build --locked --profile bench --features bench --bin neqo-client --bin neqo-server

      - name: Build walltime benchmarks
        if: needs.bench-matrix.outputs.has-walltime == 'true'
        env:
          WALLTIME_BENCHES: ${{ needs.bench-matrix.outputs.walltime-benches }}
        run: |
          cargo binstall cargo-codspeed --locked --force
          cargo codspeed build -p neqo-bench --features bench --locked -m walltime

      - name: Bundle artifacts
        run: |
          mkdir -p dist/lib
          # Neqo binaries
          cp target/release/neqo-client target/release/neqo-server dist/
          # Codspeed benchmarks
          cp -r target/codspeed dist/
          # Test fixture for certificate database
          cp -r test-fixture dist/
          # NSS/NSPR libraries
          if [ -d "$NSS_DIR/../dist/Release/lib" ]; then
            cp -L "$NSS_DIR"/../dist/Release/lib/*.so dist/lib/ 2>/dev/null || true
            cp -L "$NSS_DIR"/../dist/Release/lib/*.so.* dist/lib/ 2>/dev/null || true
          else
            for lib in nss3 nssutil3 smime3 ssl3 nspr4 plc4 plds4; do
              cp -L /usr/lib/*/lib${lib}.so* dist/lib/ 2>/dev/null || true
            done
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-neqo
          path: dist
          retention-days: 1

  build-msquic:
    name: Build msquic
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: msquic
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-msquic

  build-google:
    name: Build google/quiche
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: google
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-google

  build-quiche:
    name: Build cloudflare/quiche
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: quiche
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-quiche

  build-s2n:
    name: Build s2n-quic
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: s2n
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-s2n

  benchmarks-walltime:
    name: Criterion
    runs-on: # zizmor: ignore[self-hosted-runner]
      labels: codspeed-macro
    needs: [bench-matrix, build-neqo, build-quiche, build-google]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          tools: cargo-codspeed
          token: ${{ secrets.GITHUB_TOKEN }}
          cache-key-suffix: -codspeed

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-neqo
          path: dist
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-quiche
          path: build-quiche
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-google
          path: build-google

      - name: Set up build artifacts
        run: |
          mkdir -p target
          mv dist/codspeed target/
          find target/codspeed -type f -exec chmod +x {} +
          chmod +x build-*/*
          {
            echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/dist/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$GITHUB_WORKSPACE/dist/test-fixture/db"
          } >> "$GITHUB_ENV"

      - name: Setup test environment
        uses: ./.github/actions/testdata-setup
        with:
          sizes: ${{ env.TRANSFER_SIZE }}
          mtu: "1500"

      - name: Prepare machine
        id: cpu-tuning
        uses: ./.github/actions/cpu-tuning
        with:
          select-cpus: "true"

      - name: Generate commands (quiche-quiche)
        id: cmd-quiche-quiche
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: quiche
          size: ${{ env.TRANSFER_SIZE }}
          quiche-path: ${{ github.workspace }}/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Generate commands (google-neqo)
        id: cmd-google-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: google
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/dist
          google-path: ${{ github.workspace }}/build-google
          testdata-path: ${{ github.workspace }}/testdata

      - name: Generate commands (quiche-neqo)
        id: cmd-quiche-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/dist
          quiche-path: ${{ github.workspace }}/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set perfcompare environment
        env:
          SERVER_CPU: ${{ steps.cpu-tuning.outputs.server-cpu }}
          CLIENT_CPU: ${{ steps.cpu-tuning.outputs.client-cpu }}
        run: |
          {
            echo "QUICHE_QUICHE_SERVER_CMD=taskset -c $SERVER_CPU ${{ steps.cmd-quiche-quiche.outputs.server-cmd }}"
            echo "QUICHE_QUICHE_CLIENT_CMD=taskset -c $CLIENT_CPU ${{ steps.cmd-quiche-quiche.outputs.client-cmd }}"
            echo "GOOGLE_NEQO_SERVER_CMD=taskset -c $SERVER_CPU ${{ steps.cmd-google-neqo.outputs.server-cmd }}"
            echo "GOOGLE_NEQO_CLIENT_CMD=taskset -c $CLIENT_CPU ${{ steps.cmd-google-neqo.outputs.client-cmd }}"
            echo "QUICHE_NEQO_SERVER_CMD=taskset -c $SERVER_CPU ${{ steps.cmd-quiche-neqo.outputs.server-cmd }}"
            echo "QUICHE_NEQO_CLIENT_CMD=taskset -c $CLIENT_CPU ${{ steps.cmd-quiche-neqo.outputs.client-cmd }}"
          } >> "$GITHUB_ENV"

      - name: Run bench & upload results
        uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
        with:
          mode: walltime
          run: |
            cargo binstall cargo-codspeed --locked --force
            cargo codspeed run -p neqo-bench
          runner-version: branch:cod-2233-investigate-neqo-variance
          upload-url: ${{ secrets.DEV_GUILLAUME_CODSPEED_UPLOAD_URL }}

  perfcompare:
    name: Performance comparison
    needs: [build-neqo, build-msquic, build-google, build-quiche, build-s2n]
    runs-on: # zizmor: ignore[self-hosted-runner]
      labels: codspeed-macro

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          token: ${{ secrets.GITHUB_TOKEN }}
          cache-key-suffix: -codspeed

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-neqo
          path: build-neqo
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-msquic
          path: build-msquic
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-google
          path: build-google
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-quiche
          path: build-quiche
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-s2n
          path: build-s2n

      - run: chmod +x build-*/*

      - name: Setup test environment
        uses: ./.github/actions/testdata-setup
        with:
          sizes: ${{ env.TRANSFER_SIZE }}
          mtu: "1500"

      - name: Set environment
        run: |
          {
            echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/build-neqo/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$GITHUB_WORKSPACE/build-neqo/test-fixture/db"
          } >> "$GITHUB_ENV"

      - name: Prepare machine
        id: cpu-tuning
        uses: ./.github/actions/cpu-tuning
        with:
          select-cpus: "true"

      - name: Set CPU pinning environment
        env:
          SERVER_CPU: ${{ steps.cpu-tuning.outputs.server-cpu }}
          CLIENT_CPU: ${{ steps.cpu-tuning.outputs.client-cpu }}
        run: |
          {
            echo "SERVER_CPU=$SERVER_CPU"
            echo "CLIENT_CPU=$CLIENT_CPU"
          } >> "$GITHUB_ENV"

      - run: cargo install --locked --git https://github.com/CodSpeedHQ/codspeed --branch "cod-2233-investigate-neqo-variance" exec-harness

      # --- quiche vs quiche ---
      - name: Generate commands (quiche-quiche)
        id: cmd-quiche-quiche
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: quiche
          size: ${{ env.TRANSFER_SIZE }}
          quiche-path: ${{ github.workspace }}/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set command environment (quiche-quiche)
        env:
          BENCH_NAME: ${{ steps.cmd-quiche-quiche.outputs.bench-name }}
          SERVER_CMD: ${{ steps.cmd-quiche-quiche.outputs.server-cmd }}
          CLIENT_CMD: ${{ steps.cmd-quiche-quiche.outputs.client-cmd }}
        run: |
          {
            echo "BENCH_NAME=$BENCH_NAME"
            echo "SERVER_CMD=$SERVER_CMD"
            echo "CLIENT_CMD=$CLIENT_CMD"
          } >> "$GITHUB_ENV"

      - name: Start server (quiche-quiche)
        run: |
          # shellcheck disable=SC2086
          taskset -c "$SERVER_CPU" $SERVER_CMD &
          echo "SERVER_PID=$!" >> "$GITHUB_ENV"
          sleep 1

      - name: Create benchmark config (quiche-quiche)
        run: |
          {
            echo "benchmarks:"
            echo "  - name: \"$BENCH_NAME\""
            echo "    exec: taskset -c $CLIENT_CPU $CLIENT_CMD"
            echo "    options:"
            echo "      min-rounds: 150"
          } > codspeed.yml

      - name: Run benchmark (quiche-quiche)
        uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
        with:
          mode: walltime
          working-directory: /tmp
          runner-version: branch:cod-2233-investigate-neqo-variance
          upload-url: ${{ secrets.DEV_GUILLAUME_CODSPEED_UPLOAD_URL }}
          config: ${{ github.workspace }}/codspeed.yml

      - name: Stop server (quiche-quiche)
        if: always()
        run: kill "$SERVER_PID" 2>/dev/null || true; wait "$SERVER_PID" 2>/dev/null || true

      # --- google vs neqo ---
      - name: Generate commands (google-neqo)
        id: cmd-google-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: google
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/build-neqo
          google-path: ${{ github.workspace }}/build-google
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set command environment (google-neqo)
        env:
          BENCH_NAME: ${{ steps.cmd-google-neqo.outputs.bench-name }}
          SERVER_CMD: ${{ steps.cmd-google-neqo.outputs.server-cmd }}
          CLIENT_CMD: ${{ steps.cmd-google-neqo.outputs.client-cmd }}
        run: |
          {
            echo "BENCH_NAME=$BENCH_NAME"
            echo "SERVER_CMD=$SERVER_CMD"
            echo "CLIENT_CMD=$CLIENT_CMD"
          } >> "$GITHUB_ENV"

      - name: Start server (google-neqo)
        run: |
          # shellcheck disable=SC2086
          taskset -c "$SERVER_CPU" $SERVER_CMD &
          echo "SERVER_PID=$!" >> "$GITHUB_ENV"
          sleep 1

      - name: Create benchmark config (google-neqo)
        run: |
          {
            echo "benchmarks:"
            echo "  - name: \"$BENCH_NAME\""
            echo "    exec: taskset -c $CLIENT_CPU $CLIENT_CMD"
            echo "    options:"
            echo "      min-rounds: 150"
          } > codspeed.yml

      - name: Run benchmark (google-neqo)
        uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
        with:
          mode: walltime
          working-directory: /tmp
          runner-version: branch:cod-2233-investigate-neqo-variance
          upload-url: ${{ secrets.DEV_GUILLAUME_CODSPEED_UPLOAD_URL }}
          config: ${{ github.workspace }}/codspeed.yml

      - name: Stop server (google-neqo)
        if: always()
        run: kill "$SERVER_PID" 2>/dev/null || true; wait "$SERVER_PID" 2>/dev/null || true

      # --- quiche vs neqo ---
      - name: Generate commands (quiche-neqo)
        id: cmd-quiche-neqo
        uses: ./.github/actions/perfcompare-commands
        with:
          client: quiche
          server: neqo
          size: ${{ env.TRANSFER_SIZE }}
          cubic: "true"
          pacing: "true"
          neqo-path: ${{ github.workspace }}/build-neqo
          quiche-path: ${{ github.workspace }}/build-quiche
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set command environment (quiche-neqo)
        env:
          BENCH_NAME: ${{ steps.cmd-quiche-neqo.outputs.bench-name }}
          SERVER_CMD: ${{ steps.cmd-quiche-neqo.outputs.server-cmd }}
          CLIENT_CMD: ${{ steps.cmd-quiche-neqo.outputs.client-cmd }}
        run: |
          {
            echo "BENCH_NAME=$BENCH_NAME"
            echo "SERVER_CMD=$SERVER_CMD"
            echo "CLIENT_CMD=$CLIENT_CMD"
          } >> "$GITHUB_ENV"

      - name: Start server (quiche-neqo)
        run: |
          # shellcheck disable=SC2086
          taskset -c "$SERVER_CPU" $SERVER_CMD &
          echo "SERVER_PID=$!" >> "$GITHUB_ENV"
          sleep 1

      - name: Create benchmark config (quiche-neqo)
        run: |
          {
            echo "benchmarks:"
            echo "  - name: \"$BENCH_NAME\""
            echo "    exec: taskset -c $CLIENT_CPU $CLIENT_CMD"
            echo "    options:"
            echo "      min-rounds: 150"
          } > codspeed.yml

      - name: Run benchmark (quiche-neqo)
        uses: CodSpeedHQ/action@4deb3275dd364fb96fb074c953133d29ec96f80f # v4.10.6
        with:
          mode: walltime
          working-directory: /tmp
          runner-version: branch:cod-2233-investigate-neqo-variance
          upload-url: ${{ secrets.DEV_GUILLAUME_CODSPEED_UPLOAD_URL }}
          config: ${{ github.workspace }}/codspeed.yml

      - name: Stop server (quiche-neqo)
        if: always()
        run: kill "$SERVER_PID" 2>/dev/null || true; wait "$SERVER_PID" 2>/dev/null || true
