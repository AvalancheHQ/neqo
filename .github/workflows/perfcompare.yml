name: Performance comparison
on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:
env:
  MTU: 1504 # https://github.com/microsoft/msquic/issues/4618
  TRANSFER_SIZE: 33554432 # 32 MiB

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  perfcompare:
    name: Performance comparison
    runs-on: "codspeed-macro" # zizmor: ignore[self-hosted-runner]
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install Rust
        uses: ./.github/actions/rust
        with:
          version: stable
          tools: hyperfine
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up build artifacts
        run: |
          ARTS="$GITHUB_WORKSPACE/artifacts"
          chmod +x "$ARTS"/build-quiche/* "$ARTS"/build-google/*
          chmod +x "$ARTS/build-neqo/neqo-client" "$ARTS/build-neqo/neqo-server"

          # perfcompare.py expects these paths relative to workspace:
          #   binaries/neqo/{neqo-client,neqo-server}
          #   binaries/neqo-main/{neqo-client,neqo-server}  (baseline, same snapshot)
          #   google-quiche/bazel-bin/quiche/{quic_client,quic_server}
          #   quiche/target/release/{quiche-client,quiche-server}
          mkdir -p binaries/neqo binaries/neqo-main
          cp "$ARTS/build-neqo/neqo-client" "$ARTS/build-neqo/neqo-server" binaries/neqo/
          cp "$ARTS/build-neqo/neqo-client" "$ARTS/build-neqo/neqo-server" binaries/neqo-main/

          mkdir -p google-quiche/bazel-bin/quiche
          cp "$ARTS"/build-google/* google-quiche/bazel-bin/quiche/

          mkdir -p quiche/target/release
          cp "$ARTS"/build-quiche/* quiche/target/release/

          {
            echo "LD_LIBRARY_PATH=$ARTS/build-neqo/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$ARTS/build-neqo/test-fixture/db"
            echo "NSS_DIR=$ARTS/build-neqo/nss"
            echo "NSS_PREBUILT=1"
          } >> "$GITHUB_ENV"

      - name: Prepare machine
        run: |
          # Create cpusets for pinning server (cpu2 -> CPU 14) and client (cpu3 -> CPU 15)
          sudo mkdir -p /cpusets
          sudo mount -t cgroup -o cpuset cpuset /cpusets 2>/dev/null || true
          sudo mkdir -p /cpusets/cpu23
          echo 14-15 | sudo tee /cpusets/cpu23/cpuset.cpus
          echo 0 | sudo tee /cpusets/cpu23/cpuset.mems
          sudo mkdir -p /cpusets/cpu2
          echo 14 | sudo tee /cpusets/cpu2/cpuset.cpus
          echo 0 | sudo tee /cpusets/cpu2/cpuset.mems
          sudo mkdir -p /cpusets/cpu3
          echo 15 | sudo tee /cpusets/cpu3/cpuset.cpus
          echo 0 | sudo tee /cpusets/cpu3/cpuset.mems
          # See https://github.com/microsoft/msquic/issues/4618#issuecomment-2422611592
          sudo ip link set dev lo mtu "$MTU"

      - name: Compare QUIC implementations
        run: |
          cargo install hyperfine --force
          sudo \
            LD_LIBRARY_PATH="$LD_LIBRARY_PATH" \
            NSS_DB_PATH="$NSS_DB_PATH" \
            NSS_DIR="$NSS_DIR" \
            NSS_PREBUILT="$NSS_PREBUILT" \
            PATH="$PATH" \
            python3 .github/scripts/perfcompare.py \
            --host 127.0.0.1 \
            --port 4433 \
            --size "$TRANSFER_SIZE" \
            --runs 150 \
            --workspace "$GITHUB_WORKSPACE"

      - name: Restore machine
        if: success() || failure() || cancelled()
        run: |
          # sudo /root/bin/unprep.sh
          sudo ip link set dev lo mtu 65536

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: perfcompare-${{ github.run_id }}-${{ github.run_attempt }}
          path: hyperfine/*.json
          compression-level: 0

      - name: Cleanup
        if: always()
        run: rm -rf binaries hyperfine hyperfine-main google-quiche quiche
