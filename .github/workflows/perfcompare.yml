name: Performance comparison
on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:
env:
  MTU: 1504 # https://github.com/microsoft/msquic/issues/4618
  TRANSFER_SIZE: 33554432 # 32 MiB
  HOST: 127.0.0.1
  PORT: 4433

permissions:
  contents: read

jobs:
  perfcompare:
    name: Performance comparison
    runs-on: "codspeed-macro" # zizmor: ignore[self-hosted-runner]
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up build artifacts
        run: |
          ARTS="$GITHUB_WORKSPACE/artifacts"
          chmod +x "$ARTS"/build-quiche/* "$ARTS"/build-google/*
          chmod +x "$ARTS/build-neqo/neqo-client" "$ARTS/build-neqo/neqo-server"

          # perfcompare.py expects these paths relative to workspace:
          #   binaries/neqo/{neqo-client,neqo-server}
          #   google-quiche/bazel-bin/quiche/{quic_client,quic_server}
          #   quiche/target/release/{quiche-client,quiche-server}
          mkdir -p binaries/neqo
          cp "$ARTS/build-neqo/neqo-client" "$ARTS/build-neqo/neqo-server" binaries/neqo/

          mkdir -p google-quiche/bazel-bin/quiche
          cp "$ARTS"/build-google/* google-quiche/bazel-bin/quiche/

          mkdir -p quiche/target/release
          cp "$ARTS"/build-quiche/* quiche/target/release/

          {
            echo "LD_LIBRARY_PATH=$ARTS/build-neqo/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$ARTS/build-neqo/test-fixture/db"
            echo "NSS_DIR=$ARTS/build-neqo/nss"
            echo "NSS_PREBUILT=1"
          } >> "$GITHUB_ENV"

      - name: Install Rust
        uses: ./.github/actions/rust
        with:
          version: stable
          tools: hyperfine
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up testdata
        run: |
          mkdir -p testdata
          openssl req -nodes -new -x509 \
            -keyout testdata/key \
            -out testdata/cert \
            -subj "/CN=DOMAIN" 2>/dev/null
          truncate -s "$TRANSFER_SIZE" "testdata/$TRANSFER_SIZE"
          echo "TESTDATA=$GITHUB_WORKSPACE/testdata" >> "$GITHUB_ENV"

      # Disable turboboost, hyperthreading and use performance governor.
      # Also creates "cpu23", "cpu2" and "cpu3" CPU sets for use with cset.
      # On the bencher, logical cores 2 and 3 have been isolated for use by the benchmarks.
      - name: Prepare machine
        run: |
          # Create cpusets for pinning server (cpu2 -> CPU 14) and client (cpu3 -> CPU 15)
          sudo mkdir -p /cpusets
          sudo mount -t cgroup -o cpuset cpuset /cpusets 2>/dev/null || true
          sudo mkdir -p /cpusets/cpu23
          echo 14-15 | sudo tee /cpusets/cpu23/cpuset.cpus
          echo 0 | sudo tee /cpusets/cpu23/cpuset.mems
          sudo mkdir -p /cpusets/cpu2
          echo 14 | sudo tee /cpusets/cpu2/cpuset.cpus
          echo 0 | sudo tee /cpusets/cpu2/cpuset.mems
          sudo mkdir -p /cpusets/cpu3
          echo 15 | sudo tee /cpusets/cpu3/cpuset.cpus
          echo 0 | sudo tee /cpusets/cpu3/cpuset.mems
          # See https://github.com/microsoft/msquic/issues/4618#issuecomment-2422611592
          sudo ip link set dev lo mtu "$MTU"

      - name: Run benchmarks
        run: |
          WS="$GITHUB_WORKSPACE"
          mkdir -p results

          # Exact hyperfine invocation from perfcompare.py's hyperfine():
          #   nice -n -20 setarch --addr-no-randomize hyperfine
          #     --command-name NAME
          #     --time-unit millisecond
          #     --export-json OUT
          #     --output null
          #     --warmup 5
          #     --min-runs RUNS
          #     --prepare "WS/SERVER_CMD & echo $! >> /cpusets/cpu2/tasks; sleep 0.2"
          #     --conclude "pkill SERVER_TAG"
          #     "echo $$ >> /cpusets/cpu3/tasks; WS/CLIENT_CMD"
          #
          # Commands (traced from perfcompare.py IMPLS + mangle() for each combination):
          #
          # quiche-quiche (cc="", pacing=False â†’ opts=[("",False)]):
          #   server: quiche/target/release/quiche-server --root TESTDATA --listen HOST:PORT --cert TESTDATA/cert --key TESTDATA/key
          #   client: quiche/target/release/quiche-client --no-verify https://HOST:PORT/SIZE
          #
          # google-neqo (cc="cubic", pacing=True):
          #   server: binaries/neqo/neqo-server --cc cubic -Q 1 HOST:PORT
          #   client: google-quiche/bazel-bin/quiche/quic_client --disable_certificate_verification https://HOST:PORT/SIZE
          #
          # quiche-neqo (cc="cubic", pacing=True):
          #   server: binaries/neqo/neqo-server --cc cubic -Q 1 HOST:PORT
          #   client: quiche/target/release/quiche-client --no-verify https://HOST:PORT/SIZE

          run_bench() {
            local name="$1" server_cmd="$2" client_cmd="$3"
            local tag
            tag=$(basename "${server_cmd%% *}")
            tag="${tag:0:15}"
            sudo nice -n -20 setarch --addr-no-randomize \
              hyperfine \
                --command-name "$name" \
                --time-unit millisecond \
                --export-json "results/$name.json" \
                --output null \
                --warmup 5 \
                --min-runs 100 \
                --prepare "$WS/$server_cmd & echo \$! >> /cpusets/cpu2/tasks; sleep 0.2" \
                --conclude "pkill $tag" \
                "echo \$\$ >> /cpusets/cpu3/tasks; $WS/$client_cmd"
          }

          # quiche-quiche
          run_bench \
            "quiche-quiche" \
            "quiche/target/release/quiche-server --root $TESTDATA --listen $HOST:$PORT --cert $TESTDATA/cert --key $TESTDATA/key" \
            "quiche/target/release/quiche-client --no-verify https://$HOST:$PORT/$TRANSFER_SIZE"

          # google-neqo
          run_bench \
            "google-neqo-cubic" \
            "binaries/neqo/neqo-server --cc cubic -Q 1 $HOST:$PORT" \
            "google-quiche/bazel-bin/quiche/quic_client --disable_certificate_verification https://$HOST:$PORT/$TRANSFER_SIZE"

          # quiche-neqo
          run_bench \
            "quiche-neqo-cubic" \
            "binaries/neqo/neqo-server --cc cubic -Q 1 $HOST:$PORT" \
            "quiche/target/release/quiche-client --no-verify https://$HOST:$PORT/$TRANSFER_SIZE"

      - name: Restore machine
        if: success() || failure() || cancelled()
        run: |
          # sudo /root/bin/unprep.sh
          sudo ip link set dev lo mtu 65536

      - name: Upload results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: perfcompare-${{ github.run_id }}-${{ github.run_attempt }}
          path: results/*.json
          compression-level: 0
